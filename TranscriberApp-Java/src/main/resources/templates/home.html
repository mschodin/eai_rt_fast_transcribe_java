<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ElevateAI Real-Time Transcriber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"/>
    <link href="/static/app.css" rel="stylesheet"/>
</head>
<body>
<div class="container py-4" style="max-width: 800px;">
    <h2 class="mb-4">ElevateAI Real-Time Transcriber</h2>

    <div class="mb-3">
        <label class="form-label fw-bold">API Token</label>
        <input type="password" id="apiToken" class="form-control"
               placeholder="Your ElevateAI API token"/>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Audio File (WAV)</label>
        <div class="d-flex align-items-center gap-2">
            <input type="file" id="audioFile" class="form-control"
                   accept=".wav"/>
            <span id="fileInfo" class="text-muted small"></span>
        </div>
    </div>

    <button id="startBtn" class="btn btn-primary px-4" onclick="startTranscription()">
        Start Transcription
    </button>

    <h3 class="mt-4">Messages</h3>
    <div id="messageLog" class="message-log"></div>

    <div id="resultSection" style="display: none;">
        <div id="interactionIdBox" class="mt-4 p-3 bg-light border rounded">
            <strong>Interaction ID:</strong> <span id="interactionId"></span>
        </div>

        <h3 class="mt-4">Transcript</h3>
        <div id="chatTranscript" class="chat-container"></div>
    </div>
</div>

<script>
    let uploadedFileId = null;

    document.getElementById('audioFile').addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            document.getElementById('fileInfo').textContent =
                file.name + ' (' + file.size.toLocaleString() + ' bytes)';
        }
    });

    function clearElement(el) {
        while (el.firstChild) {
            el.removeChild(el.firstChild);
        }
    }

    function formatTime(ms) {
        const totalSec = Math.floor(ms / 1000);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return min + ':' + String(sec).padStart(2, '0');
    }

    function renderTranscript(result) {
        const container = document.getElementById('chatTranscript');
        clearElement(container);

        document.getElementById('interactionId').textContent =
            result.interactionIdentifier || '(none)';

        const segments = result.segments || [];
        if (segments.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'text-muted p-3';
            empty.textContent = '(no speech detected)';
            container.appendChild(empty);
            return;
        }

        segments.forEach(function (seg) {
            const isP1 = seg.participant === 'participantOne';
            const label = isP1 ? 'Agent' : 'Customer';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble ' + (isP1 ? 'chat-p1' : 'chat-p2');

            const header = document.createElement('div');
            header.className = 'chat-header';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'chat-name';
            nameSpan.textContent = label;

            const timeSpan = document.createElement('span');
            timeSpan.className = 'chat-time';
            timeSpan.textContent = formatTime(seg.startMs);

            header.appendChild(nameSpan);
            header.appendChild(timeSpan);

            const text = document.createElement('div');
            text.className = 'chat-text';
            text.textContent = seg.phrase;

            bubble.appendChild(header);
            bubble.appendChild(text);
            container.appendChild(bubble);
        });
    }

    async function startTranscription() {
        const token = document.getElementById('apiToken').value.trim();
        const fileInput = document.getElementById('audioFile');
        const btn = document.getElementById('startBtn');
        const logDiv = document.getElementById('messageLog');
        const resultSection = document.getElementById('resultSection');

        if (!token) {
            addMessage(logDiv, 'ERROR: Please enter your API token.');
            return;
        }
        if (!fileInput.files.length) {
            addMessage(logDiv, 'ERROR: Please select an audio file.');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Transcribing...';
        clearElement(logDiv);
        resultSection.style.display = 'none';

        try {
            // Upload file
            addMessage(logDiv, 'Uploading file...');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const uploadResp = await fetch('/upload', {method: 'POST', body: formData});
            const uploadData = await uploadResp.json();

            if (!uploadResp.ok) {
                addMessage(logDiv, 'ERROR: Upload failed â€” ' + (uploadData.error || 'unknown'));
                return;
            }

            addMessage(logDiv, 'File uploaded: ' + uploadData.fileName + ' (' + uploadData.size.toLocaleString() + ' bytes)');
            uploadedFileId = uploadData.fileId;

            // Start SSE transcription
            const url = '/transcribe?fileId=' + encodeURIComponent(uploadedFileId)
                + '&token=' + encodeURIComponent(token);
            const source = new EventSource(url);

            source.onmessage = function (e) {
                addMessage(logDiv, e.data);
            };

            source.addEventListener('transcript', function (e) {
                try {
                    const result = JSON.parse(e.data);
                    renderTranscript(result);
                    resultSection.style.display = 'block';
                    addMessage(logDiv, '--- TRANSCRIPTION COMPLETE ---');
                } catch (parseErr) {
                    addMessage(logDiv, 'ERROR: Failed to parse transcript result');
                }
            });

            source.addEventListener('done', function () {
                source.close();
                btn.disabled = false;
                btn.textContent = 'Start Transcription';
            });

            source.onerror = function () {
                source.close();
                addMessage(logDiv, 'ERROR: Connection lost.');
                btn.disabled = false;
                btn.textContent = 'Start Transcription';
            };
        } catch (err) {
            addMessage(logDiv, 'ERROR: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Start Transcription';
        }
    }

    function addMessage(logDiv, msg) {
        const now = new Date();
        const ts = now.toTimeString().substring(0, 8);
        const div = document.createElement('div');
        div.textContent = '[' + ts + '] ' + msg;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
</script>
</body>
</html>
