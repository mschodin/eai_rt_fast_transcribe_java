<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ElevateAI Real-Time Transcriber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"/>
    <link href="/static/app.css" rel="stylesheet"/>
</head>
<body>
<div class="container py-4" style="max-width: 800px;">
    <h2 class="mb-4">ElevateAI Real-Time Transcriber</h2>

    <div class="mb-3">
        <label class="form-label fw-bold">API Token</label>
        <input type="password" id="apiToken" class="form-control"
               placeholder="Your ElevateAI API token"/>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Audio File (m4a, wav, mp3, etc.)</label>
        <div class="d-flex align-items-center gap-2">
            <input type="file" id="audioFile" class="form-control"
                   accept=".m4a,.wav,.mp3,.ogg,.flac,.aac,.wma"/>
            <span id="fileInfo" class="text-muted small"></span>
        </div>
    </div>

    <button id="startBtn" class="btn btn-primary px-4" onclick="startTranscription()">
        Start Transcription
    </button>

    <h3 class="mt-4">Messages</h3>
    <div id="messageLog" class="message-log"></div>

    <div id="resultSection" style="display: none;">
        <div id="interactionIdBox" class="mt-4 p-3 bg-light border rounded">
            <strong>Interaction ID:</strong> <span id="interactionId"></span>
        </div>

        <h3 class="mt-4">Participant One (Agent)</h3>
        <div id="participantOneText" class="transcript-box transcript-p1"></div>

        <h3 class="mt-3">Participant Two (Customer)</h3>
        <div id="participantTwoText" class="transcript-box transcript-p2"></div>

        <h3 class="mt-3">Full Transcript</h3>
        <div id="fullTranscriptText" class="transcript-box"></div>
    </div>
</div>

<script>
    let uploadedFileId = null;

    document.getElementById('audioFile').addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            document.getElementById('fileInfo').textContent =
                file.name + ' (' + file.size.toLocaleString() + ' bytes)';
        }
    });

    function clearElement(el) {
        while (el.firstChild) {
            el.removeChild(el.firstChild);
        }
    }

    async function startTranscription() {
        const token = document.getElementById('apiToken').value.trim();
        const fileInput = document.getElementById('audioFile');
        const btn = document.getElementById('startBtn');
        const logDiv = document.getElementById('messageLog');
        const resultSection = document.getElementById('resultSection');

        if (!token) {
            addMessage(logDiv, 'ERROR: Please enter your API token.');
            return;
        }
        if (!fileInput.files.length) {
            addMessage(logDiv, 'ERROR: Please select an audio file.');
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Transcribing...';
        clearElement(logDiv);
        resultSection.style.display = 'none';

        try {
            // Upload file
            addMessage(logDiv, 'Uploading file...');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const uploadResp = await fetch('/upload', {method: 'POST', body: formData});
            const uploadData = await uploadResp.json();

            if (!uploadResp.ok) {
                addMessage(logDiv, 'ERROR: Upload failed â€” ' + (uploadData.error || 'unknown'));
                return;
            }

            addMessage(logDiv, 'File uploaded: ' + uploadData.fileName + ' (' + uploadData.size.toLocaleString() + ' bytes)');
            uploadedFileId = uploadData.fileId;

            // Start SSE transcription
            const url = '/transcribe?fileId=' + encodeURIComponent(uploadedFileId)
                + '&token=' + encodeURIComponent(token);
            const source = new EventSource(url);

            source.onmessage = function (e) {
                addMessage(logDiv, e.data);
            };

            source.addEventListener('transcript', function (e) {
                try {
                    const result = JSON.parse(e.data);

                    document.getElementById('interactionId').textContent =
                        result.interactionIdentifier || '(none)';

                    document.getElementById('participantOneText').textContent =
                        result.participantOne || '(no speech detected)';

                    document.getElementById('participantTwoText').textContent =
                        result.participantTwo || '(no speech detected)';

                    document.getElementById('fullTranscriptText').textContent =
                        result.fullTranscript || '(empty)';

                    resultSection.style.display = 'block';
                    addMessage(logDiv, '--- TRANSCRIPTION COMPLETE ---');
                } catch (parseErr) {
                    addMessage(logDiv, 'ERROR: Failed to parse transcript result');
                }
            });

            source.addEventListener('done', function () {
                source.close();
                btn.disabled = false;
                btn.textContent = 'Start Transcription';
            });

            source.onerror = function () {
                source.close();
                addMessage(logDiv, 'ERROR: Connection lost.');
                btn.disabled = false;
                btn.textContent = 'Start Transcription';
            };
        } catch (err) {
            addMessage(logDiv, 'ERROR: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Start Transcription';
        }
    }

    function addMessage(logDiv, msg) {
        const now = new Date();
        const ts = now.toTimeString().substring(0, 8);
        const div = document.createElement('div');
        div.textContent = '[' + ts + '] ' + msg;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
</script>
</body>
</html>
